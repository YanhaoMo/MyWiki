# TCP 协议

# 建立连接

为了保证可靠连接，tcp建立连接需要“三次握手”，这三次握手对tcp的性能有至关重要的影响。
如何缩小这三次握手给性能带来的影响是网络性能调优的一个重要关注点。

### 三次握手

* 客户端发送`SYN(SEQ=x)`报文给服务器端，进入`SYN_SEND`状态。

net.ipv4.tcp_syn_retries: syn报文的重传次数.(至于重传机制,暂时还没搞清楚)  
net.ipv4.tcp_fastopen: 开启这个选项可以使tcp在第一个syn包中就开始传送数据.(关于这个选项还需要进一步研究:是否需要客户端也开启此选项)

* 服务器端收到SYN报文，进入`SYN_RECV`状态，回应一个`SYN(SEQ=y)ACK(ACK=x+1)`报文。

net.ipv4.tcp_max_syn_backlog: 服务器中syn队列的长度.  
sysctl -w net.ipv4.tcp_syncookies=1 ,　打开syncookie，在syn backlog队列不足的时候，提供一种机制临时将syn链接换出  
net.ipv4.tcp_synack_retries: synack报文的重传次数.(同样地,还未搞清楚重传机制)


* 客户端收到服务器端的SYN报文，回应一个`ACK(ACK=y+1)`报文，进入`Established`状态。

至此，整个连接建立完成。



下面分析“三次握手”的过程中包含的几种状态：

* SYN_SEND 
* SYN_RECV
* ESTABLISHED

# 拥塞控制

拥塞控制机制是传输层为了保证网络质量而施加的保护措施，但是这样一来，
整个拥塞控制机制会使得tcp连接在很多时候难以发挥出最好的性能，
如何减小tcp拥塞控制带来的性能损失，也是tcp性能调优的一个关键点。

拥塞控制的几个关键词

慢开始，拥塞避免，快恢复，快重传

拥塞控制的几个关键参数：

下面的几个变量是用来配置拥塞控制的。

* snd_cwnd          设置拥塞窗口大小
* snd_ssthresh      慢开始门限
* snd\_cwnd_cnt
* snd\_cwnd_clamp
* snd\_cwnd_stamp
* snd\_cwnd_used

# 释放连接
TCP连接的释放也是一个复杂的过程，在这个地方，提升网络性能的关键是如何快速释放一个不在使用的连接，
或者如何重用一个连接。

* 客户端发起关闭请求，发送一个信息：`FIN(m)`，此时客户端进入`FIN_WAIT1`状态,服务器端在接收到FIN后,进入`CLOSE_WAIT`状态。
* 服务端接受到信息后，首先返回`ACK(m+1)`,表明自己已经收到消息。客户端在收到服务器端的ACK之后,进入`FIN_WAIT2`状态.
* 服务端在准备好关闭之前，最后发送给客户端一个`FIN(n)`消息，询问客户端是否准备好关闭了。此时服务器进入`LASK_ACK`状态.
* 客户端接受到服务端发送的消息后，返回一个确认信息: `ACK(n+1)`,此时客户端进入`TIME_WAIT`状态.
* 最后，服务端和客户端在双方都得到确认时，再经过一定时间之后,双方状态都变为`CLOSED`,此时连接关闭。

# 特殊机制
tcp中还存一些特殊机制来应对各种不同的情况，这些地方的性能问题也是值得考察的。